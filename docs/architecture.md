# Архитектура системы TW Accounting

## Обзор системы

TW Accounting - это современная микросервисная система для ведения бухгалтерского учета с поддержкой криптовалют и веб-аналитики. Система построена по принципам Clean Architecture и Domain-Driven Design.

## Архитектурные принципы

### 1. Микросервисная архитектура
- Слабосвязанные сервисы с четко определенными границами
- Каждый сервис отвечает за свою бизнес-область
- Горизонтальная масштабируемость
- Независимое развертывание сервисов

### 2. API-First подход
- OpenAPI спецификация для всех API
- Автоматическая генерация документации
- Контрактное тестирование
- Версионирование API

### 3. Event-Driven Architecture (планируется)
- Асинхронное взаимодействие через события
- Event Sourcing для аудита транзакций
- CQRS для разделения команд и запросов

## Компоненты системы

### Backend Services

#### 1. Accounting Service (порт 8001)
**Назначение:** Основной сервис бухгалтерского учета

**Технологии:**
- FastAPI - веб-фреймворк
- SQLModel - ORM с поддержкой Pydantic
- PostgreSQL - основная база данных
- Redis - кэширование
- Alembic - миграции

**Основные модули:**
```
app/
├── api/                 # API роуты
│   ├── auth.py         # Аутентификация
│   ├── accounts.py     # Управление счетами
│   ├── transactions.py # Операции с транзакциями
│   ├── crypto.py       # Криптовалютные операции
│   ├── projects.py     # Проекты
│   ├── categories.py   # Категории
│   └── counterparties.py # Контрагенты
├── core/               # Базовая конфигурация
│   ├── config.py       # Настройки приложения
│   ├── database.py     # Подключение к БД
│   └── auth.py         # Система авторизации
├── models/             # Модели данных
│   ├── users.py        # Пользователи
│   ├── accounts.py     # Счета
│   ├── transactions.py # Транзакции
│   ├── projects.py     # Проекты
│   ├── categories.py   # Категории
│   └── counterparties.py # Контрагенты
├── services/           # Бизнес-логика
│   ├── transactions.py # Сервис транзакций
│   └── crypto.py       # Сервис криптовалют
└── main.py            # Точка входа
```

**Ключевые особенности:**
- Принцип двойной записи в бухгалтерии
- Поддержка криптовалют (TRX, USDT)
- Автоматическая конвертация курсов
- JWT аутентификация
- Валидация данных с Pydantic

#### 2. API Gateway (порт 8000)
**Назначение:** Единая точка входа для всех API запросов

**Функции:**
- Маршрутизация запросов к сервисам
- Аутентификация и авторизация
- Rate limiting
- Логирование запросов
- CORS настройки

#### 3. Traffic Analytics Service (порт 8002)
**Назначение:** Сбор и анализ веб-аналитики

**Функции:**
- Отслеживание посещений
- Анализ поведения пользователей
- Сбор метрик производительности
- Отчеты по трафику

### Database Layer

#### PostgreSQL + TimescaleDB (порт 5432)
**Назначение:** Основное хранилище данных

**Особенности:**
- TimescaleDB для временных рядов
- ACID транзакции
- Полнотекстовый поиск
- JSON поддержка
- Репликация (планируется)

**Основные таблицы:**
```sql
-- Пользователи и аутентификация
users
user_sessions

-- Справочники
accounts (счета)
projects (проекты)
categories (категории)
counterparties (контрагенты)

-- Транзакции
transactions (основные транзакции)
transaction_entries (проводки)
crypto_transaction_details (крипто-детали)

-- Аналитика (планируется)
analytics_events
user_sessions_analytics
```

#### Redis (порт 6379)
**Назначение:** Кэширование и очереди

**Использование:**
- Кэширование API ответов
- Сессии пользователей
- Очереди задач (Celery, планируется)
- Rate limiting данные
- Курсы криптовалют

### Frontend

#### React Application (порт 3000)
**Назначение:** Веб-интерфейс пользователя

**Технологии:**
- React 18 с TypeScript
- Vite - сборщик и dev сервер
- Tailwind CSS - стилизация
- React Query - управление состоянием сервера
- Zustand - клиентское состояние
- React Router - маршрутизация

**Архитектура:**
```
src/
├── components/         # Переиспользуемые компоненты
│   ├── Layout.tsx     # Основной лэйаут
│   ├── Sidebar.tsx    # Боковая панель
│   └── ui/            # UI компоненты
├── pages/             # Страницы приложения
│   ├── Dashboard.tsx  # Главная панель
│   ├── Login.tsx      # Вход в систему
│   ├── Accounts.tsx   # Управление счетами
│   └── Transactions.tsx # Транзакции
├── services/          # API клиенты
│   └── api.ts         # Основной API клиент
├── hooks/             # React хуки
│   └── useAuth.ts     # Хук аутентификации
├── types/             # TypeScript типы
│   └── index.ts       # Основные типы
└── utils/             # Утилиты
    └── index.ts       # Форматеры и валидаторы
```

## Принципы работы

### 1. Система двойной записи

Каждая финансовая транзакция создает две или более проводки:
```
Доход $1000:
- DEBIT: Банковский счет +$1000
- CREDIT: Счет доходов -$1000

Расход $500:
- DEBIT: Счет расходов +$500  
- CREDIT: Банковский счет -$500

Перевод $300:
- DEBIT: Счет получатель +$300
- CREDIT: Счет отправитель -$300
```

### 2. Обработка криптовалют

1. Получение курса из CoinGecko API
2. Конвертация в USD по текущему курсу  
3. Создание стандартной транзакции в USD
4. Сохранение крипто-метаданных
5. Валидация через TronScan API (опционально)

### 3. Аутентификация и безопасность

**JWT токены:**
- Access токен для API запросов
- Время жизни: 30 минут
- Хранение в localStorage (frontend)
- Автоматическое обновление

**Безопасность:**
- Хэширование паролей с Argon2
- HTTPS в продакшене
- CORS настройки
- Rate limiting
- Валидация всех входных данных

## Паттерны и подходы

### 1. Repository Pattern
```python
class TransactionService:
    def __init__(self, db: Session):
        self.db = db
    
    def create_transaction(self, data: TransactionCreate) -> Transaction:
        # Бизнес-логика создания транзакции
        pass
```

### 2. Dependency Injection
```python
@router.post("/transactions/")
def create_transaction(
    data: TransactionCreate,
    db: Session = Depends(get_session),
    user: User = Depends(current_user)
):
    service = TransactionService(db)
    return service.create_transaction(data)
```

### 3. DTO Pattern
```python
# Входные данные
class TransactionCreate(BaseModel):
    amount: Decimal
    description: str
    # ...

# Выходные данные  
class TransactionRead(BaseModel):
    id: int
    amount: Decimal
    status: str
    # ...
```

## Масштабирование

### Горизонтальное масштабирование
- Статeless сервисы
- Load balancer (Nginx, планируется)
- Репликация базы данных
- CDN для статики

### Вертикальное масштабирование
- Увеличение ресурсов контейнеров
- Оптимизация запросов к БД
- Кэширование на разных уровнях
- Асинхронная обработка

## Мониторинг и логирование

### Планируемые инструменты
- **Prometheus** - метрики
- **Grafana** - дашборды
- **ELK Stack** - логи
- **Jaeger** - трейсинг
- **Sentry** - отслеживание ошибок

### Метрики
- Время ответа API
- Количество запросов
- Ошибки и исключения
- Использование ресурсов
- Бизнес-метрики (транзакции, пользователи)

## Развертывание

### Development
```bash
docker compose up -d
cd frontend && npm run dev
```

### Production (планируется)
- Kubernetes кластер
- CI/CD пайплайны (GitHub Actions)
- Автоматические миграции
- Blue-green деплойменты
- Резервное копирование

## Интеграции

### Текущие
- **CoinGecko API** - курсы криптовалют
- **TronScan API** - валидация TRON транзакций

### Планируемые
- **Stripe** - платежные операции
- **Telegram Bot** - уведомления
- **Email** - отчеты и уведомления
- **External APIs** - банковские интеграции

## Безопасность

### Текущие меры
- JWT аутентификация
- Хэширование паролей
- Валидация входных данных
- CORS настройки
- Rate limiting

### Планируемые улучшения
- OAuth2 интеграция
- Multi-factor authentication
- Аудит логи
- Шифрование чувствительных данных
- Регулярные security аудиты

## Заключение

Архитектура TW Accounting обеспечивает:
- **Масштабируемость** через микросервисы
- **Надежность** через ACID транзакции
- **Безопасность** через современные стандарты
- **Гибкость** через модульную структуру
- **Производительность** через кэширование

Система готова для развития и добавления новых функций по мере роста бизнес-требований.
