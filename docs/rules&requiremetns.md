# Правила архитектуры и бизнес требования

## Архитектурные принципы

### 1. Микросервисная архитектура

#### Основные принципы
- **Разделение ответственности**: Каждый сервис отвечает за свою предметную область
- **Независимое развертывание**: Сервисы могут обновляться независимо друг от друга
- **Изоляция данных**: Каждый сервис имеет свою базу данных
- **Слабая связанность**: Сервисы взаимодействуют только через API

#### Сервисы системы
- **Accounting Service**: Учет финансов, транзакции, счета, долги
- **Traffic Analytics Service**: Аналитика трафика, метрики, импорт данных
- **API Gateway**: Единая точка входа, маршрутизация, аутентификация
- **Frontend**: Пользовательский интерфейс

### 2. Принципы проектирования API

#### RESTful API
- Использование HTTP методов (GET, POST, PUT, DELETE)
- Семантические URL-пути
- Стандартные HTTP коды ответов
- JSON как формат данных

#### Версионирование API
- Версионирование через URL: `/api/v1/`, `/api/v2/`
- Обратная совместимость в рамках мажорной версии
- Deprecation policy для устаревших эндпоинтов

#### Документация API
- Автоматическая генерация через OpenAPI/Swagger
- Примеры запросов и ответов
- Описание ошибок и их кодов

### 3. Управление данными

#### Принцип двойной записи
- Каждая транзакция должна иметь минимум две проводки
- Сумма дебетов должна равняться сумме кредитов
- Автоматическое обновление балансов счетов

#### Транзакционность
- Все операции с финансами выполняются в транзакциях БД
- Rollback при ошибках
- Идемпотентность операций

#### Аудит и логирование
- Логирование всех изменений финансовых данных
- Сохранение истории изменений
- Трассировка операций

### 4. Безопасность

#### Аутентификация и авторизация
- **FastAPI-Users** - готовая библиотека для аутентификации в FastAPI
- JWT токены для аутентификации
- RBAC (Role-Based Access Control) через роли пользователей
- Регистрация по email с подтверждением
- Восстановление пароля по email
- Простая интеграция с SQLAlchemy

#### Валидация данных
- Валидация на уровне API (Pydantic)
- Валидация на уровне БД (constraints)
- Санитизация пользовательского ввода

#### Защита данных
- Шифрование чувствительных данных
- HTTPS для всех соединений
- Защита от SQL-инъекций и XSS

## Бизнес требования

### 1. Функциональные требования

#### Учет финансов (Accounting Service)

##### Справочники
- **Счета (Accounts)**: Управление банковскими счетами и крипто-кошельками
  - Поддержка разных валют (USD, USDT, TRX)
  - Автоматический расчет балансов
  - История изменений

- **Проекты (Projects)**: Группировка операций по проектам
  - Иерархическая структура проектов
  - Настройка валюты проекта
  - Статусы проектов (активный, завершенный, приостановленный)

- **Категории (Categories)**: Классификация доходов и расходов
  - Древовидная структура категорий
  - Предустановленные категории
  - Возможность создания пользовательских категорий

- **Контрагенты (Counterparties)**: Партнеры, поставщики, клиенты
  - Контактная информация
  - История взаимодействий
  - Группировка по типам

##### Транзакции
- **Создание транзакций**: Доходы, расходы, переводы между счетами
- **Двойная запись**: Автоматическое создание проводок
- **Криптовалюты**: Поддержка TRX/USDT с деталями транзакций
- **Валидация**: Проверка корректности данных и балансов

##### Счета и долги
- **Счета на оплату (Invoices)**: Создание и управление счетами
- **Отслеживание статусов**: Черновик, отправлен, оплачен, просрочен
- **Автоматические уведомления**: О просроченных счетах
- **Отчеты по задолженности**: Дебиторская и кредиторская задолженность

##### Регулярные платежи
- **Настройка повторяющихся операций**: Ежемесячные, еженедельные
- **Автоматическое создание транзакций**: По расписанию
- **Управление шаблонами**: Создание и редактирование шаблонов

#### Аналитика трафика (Traffic Analytics Service)

##### Управление источниками данных
- **Источники трафика**: Moloco, трекеры, другие платформы
- **Партнерские программы**: Настройка условий сотрудничества
- **Офферы**: Управление предложениями и моделями выплат
- **Кампании**: Создание и отслеживание рекламных кампаний

##### Импорт данных
- **CSV файлы**: Автоматический импорт из внешних систем
- **Валидация данных**: Проверка корректности и полноты
- **Обработка ошибок**: Логирование и уведомления об ошибках
- **Фоновые задачи**: Асинхронная обработка больших файлов

##### Расчет метрик
- **CPI (Cost Per Install)**: Стоимость установки
- **CPA (Cost Per Action)**: Стоимость действия
- **ROI (Return on Investment)**: Возврат инвестиций
- **ROAS (Return on Ad Spend)**: Возврат рекламных расходов
- **LTV (Lifetime Value)**: Пожизненная ценность клиента

##### Выплаты
- **Отслеживание выплат**: Потенциальные и фактические выплаты
- **Статусы выплат**: Ожидается, подтверждена, выплачена
- **Синхронизация с бухгалтерией**: Автоматическое создание транзакций

### 2. Нефункциональные требования

#### Производительность
- **Время отклика API**: < 200ms для 95% запросов
- **Обработка больших файлов**: CSV файлы до 100MB
- **Параллельная обработка**: До 10 одновременных импортов
- **Кэширование**: Часто запрашиваемые данные

#### Масштабируемость
- **Горизонтальное масштабирование**: Возможность добавления инстансов
- **Вертикальное масштабирование**: Увеличение ресурсов сервера
- **База данных**: Партиционирование по времени для метрик
- **Кэш**: Redis кластер для высоких нагрузок

#### Надежность
- **Доступность**: 99.9% uptime
- **Резервное копирование**: Ежедневные бэкапы
- **Восстановление**: RTO < 4 часа, RPO < 1 час
- **Мониторинг**: Отслеживание состояния системы

#### Безопасность
- **Шифрование**: TLS 1.3 для передачи данных
- **Аутентификация**: FastAPI-Users с JWT токенами
- **Авторизация**: Роли и права доступа через SQLAlchemy
- **Аудит**: Логирование всех действий пользователей
- **Хеширование паролей**: Argon2 для безопасного хранения паролей

### 3. Интеграционные требования

#### Внешние системы
- **TronScan API**: Валидация крипто-транзакций
- **Курсы валют**: Автоматическое обновление курсов
- **Партнерские программы**: API для получения данных о выплатах
- **Уведомления**: Email/SMS уведомления

#### Внутренние интеграции
- **API Gateway**: Единая точка входа
- **Синхронизация данных**: Между сервисами
- **Общие библиотеки**: Переиспользуемые компоненты
- **Мониторинг**: Централизованное логирование

### 4. Пользовательские требования

#### Интерфейс
- **Адаптивность**: Работа на всех устройствах
- **Интуитивность**: Простой и понятный интерфейс
- **Производительность**: Быстрая загрузка страниц
- **Доступность**: Поддержка клавиатурной навигации

#### Отчеты и аналитика
- **Дашборды**: Ключевые метрики на главной странице
- **Фильтрация**: Гибкие фильтры по датам, проектам, категориям
- **Экспорт**: Выгрузка данных в Excel/CSV
- **Графики**: Визуализация трендов и сравнений

#### Уведомления
- **Реальные уведомления**: О важных событиях
- **Email уведомления**: Еженедельные/ежемесячные отчеты
- **Настройка уведомлений**: Персонализация под пользователя

### 5. Технические ограничения

#### База данных
- **PostgreSQL**: Основная БД для бухгалтерии
- **TimescaleDB**: Для временных рядов метрик
- **Redis**: Кэширование и очереди
- **Ограничения**: Максимум 1TB данных на сервис

#### Файловое хранилище
- **CSV файлы**: Локальное хранение или S3-совместимое
- **Размер файла**: До 100MB
- **Форматы**: CSV, Excel (опционально)
- **Архивирование**: Старые файлы через 1 год

#### API ограничения
- **Rate limiting**: 1000 запросов в минуту на пользователя
- **Размер запроса**: До 10MB
- **Timeout**: 30 секунд для синхронных операций
- **Pagination**: Обязательна для списков > 100 элементов

### 6. Соответствие стандартам

#### Финансовые стандарты
- **Принцип двойной записи**: Соответствие бухгалтерским стандартам
- **Аудит**: Возможность проведения аудита
- **Отчетность**: Стандартные финансовые отчеты
- **Валюты**: Поддержка мультивалютности

#### Технические стандарты
- **REST API**: Соответствие REST принципам
- **OpenAPI**: Документация API в стандартном формате
- **JSON**: Стандартный формат обмена данными
- **HTTP**: Стандартные коды ответов

#### Безопасность
- **OWASP**: Следование рекомендациям OWASP
- **GDPR**: Соответствие требованиям защиты данных
- **Шифрование**: Стандартные алгоритмы шифрования
- **Аутентификация**: FastAPI-Users (JWT / OAuth 2.0)
- **Хеширование**: Argon2 для паролей
